import streamlit as st
import google.generativeai as genai
from typing import Dict, List, Union
import json
from datetime import datetime
import ast
import re
import os
from dotenv import load_dotenv
from tavily import TavilyClient

# åŠ è½½ .env æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
load_dotenv()

# ==================== é…ç½®åŒºåŸŸ ====================
def get_api_key() -> str:
    try:
        if hasattr(st, 'secrets') and 'GEMINI_API_KEY' in st.secrets:
            return st.secrets['GEMINI_API_KEY']
    except Exception:
        pass
    api_key = os.getenv('GEMINI_API_KEY', '')
    return api_key if api_key else ""

def get_tavily_key() -> str:
    if hasattr(st, 'secrets') and 'TAVILY_API_KEY' in st.secrets:
        return st.secrets['TAVILY_API_KEY']
    return os.getenv('TAVILY_API_KEY', '')

TAVILY_API_KEY = get_tavily_key()
GEMINI_API_KEY = get_api_key()

# ==================== é¡µé¢é…ç½® ====================
st.set_page_config(
    page_title="PM Insight Copilot",
    page_icon="ğŸ“Š",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ==================== æ ·å¼å®šåˆ¶ ====================
st.markdown("""
    <style>
    .main-header {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 1rem;
    }
    .sub-header {
        font-size: 1.2rem;
        color: #666;
        text-align: center;
        margin-bottom: 2rem;
    }
    .analysis-section {
        padding: 1rem;
        border-radius: 8px;
        background-color: #f8f9fa;
        margin-bottom: 1rem;
    }
    </style>
""", unsafe_allow_html=True)

# ==================== åˆå§‹åŒ– Gemini ====================
def init_gemini():
    if not GEMINI_API_KEY:
        st.error("âš ï¸ è¯·é…ç½®æ‚¨çš„ Gemini API Key")
        st.stop()
    
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        generation_config = genai.types.GenerationConfig(
            max_output_tokens=8192,
            response_mime_type="application/json"
        )
        return genai.GenerativeModel("gemini-2.5-flash", generation_config=generation_config)
    except Exception as e:
        st.error(f"âŒ Gemini API åˆå§‹åŒ–å¤±è´¥: {str(e)}")
        st.stop()

def fetch_competitor_context(product_input: str) -> str:
    if not TAVILY_API_KEY:
        return "ï¼ˆæœªé…ç½® Tavily APIï¼Œä½¿ç”¨æ¨¡å‹å†…ç½®çŸ¥è¯†åˆ†æï¼‰"
    try:
        tavily = TavilyClient(api_key=TAVILY_API_KEY)
        search_query = f"{product_input} latest features user feedback and market position 2025"
        search_result = tavily.search(query=search_query, search_depth="advanced", max_results=5)
        context = "ä»¥ä¸‹æ˜¯ä»äº’è”ç½‘æœé›†çš„å®æ—¶ä¿¡æ¯ï¼š\n"
        for i, res in enumerate(search_result['results'], 1):
            context += f"èµ„æ–™[{i}]: {res['content'][:1000]}\næ¥æº: {res['url']}\n\n"
        return context
    except Exception as e:
        return f"ï¼ˆæœç´¢æ‰§è¡Œå¤±è´¥: {str(e)}ï¼‰"

# ==================== æç¤ºè¯æ¨¡æ¿ ====================
def create_partial_prompt(product_input: str, keys: List[str], web_context: str) -> str:
    descriptions = {
        "overview": "ç«å“æ¦‚å†µ (äº§å“æ ¸å¿ƒå®šä½ã€ç›®æ ‡äººç¾¤ã€3é¡¹æ ¸å¿ƒä¸šåŠ¡çº¿)",
        "ux_features": "åŠŸèƒ½åœºæ™¯ (3ä¸ªæ ¸å¿ƒåŠŸèƒ½ã€å…¸å‹ä½¿ç”¨åœºæ™¯ã€1ä¸ªç¡¬æ ¸äº¤äº’ç—›ç‚¹)",
        "growth_ops": "è¿è¥å¢é•¿ (3ä¸ªæ ¸å¿ƒå¢é•¿æ‰‹æ®µã€ç›®å‰çš„è¿è¥é‡å¿ƒã€å¢é•¿æ æ†)",
        "tech_stack": "æŠ€æœ¯æ ˆåˆ†æ (æ¨¡å‹ä¾èµ–ã€RAGæ¶æ„ç‰¹ç‚¹ã€æŠ€æœ¯å£å’)",
        "data_metrics": "å•†ä¸šåŒ–æŒ‡æ ‡ (3ä¸ªä¸»è¦å˜ç°ç‚¹ã€ä¼°ç®—çš„ ROIã€ç”¨æˆ·æ´»è·ƒåº¦)",
        "strategy_advice": "é”™ä½ç«äº‰å»ºè®® (3æ¡éå¯¹ç§°ç«äº‰ç­–ç•¥ã€å»ºè®®çš„çªç ´æ–¹å‘)"
    }
    
    task_list = "\n".join([f"- KEY: '{k}'ï¼Œé‡ç‚¹: {descriptions[k]}" for k in keys])
    
    return f"""
ä½ æ˜¯ä¸€ä½é¡¶çº§ AI äº§å“ä¸“å®¶ã€‚è¯·é’ˆå¯¹ç«å“ '{product_input}' è¿›è¡Œæ·±åº¦å»ºæ¨¡ã€‚

ã€å‚è€ƒæƒ…æŠ¥ã€‘
{web_context}

**ğŸ¯ ä»»åŠ¡ï¼š**
1. è¯·è¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œé”®åä¸¥æ ¼ä¸º: {json.dumps(keys)}ã€‚
2. æ¯ä¸ªç»´åº¦è¾“å‡º **3 ä¸ªæ ¸å¿ƒæ´å¯Ÿç‚¹**ï¼ˆBullet Pointsï¼‰ã€‚
3. ä¸¥ç¦è¾“å‡º "Executive Summary"ï¼Œç›´æ¥ä»¥ Markdown åˆ—è¡¨æˆ–æ ‡é¢˜å¼€å§‹ã€‚
4. æ€»å­—æ•°é€‚ä¸­ï¼Œç¡®ä¿å†…å®¹å…·å¤‡ä¸“ä¸šäº§å“ç»ç†çš„æ´å¯Ÿæ·±åº¦ã€‚

**åˆ†æç»´åº¦ï¼š**
{task_list}
"""

# ==================== å·¥å…·å‡½æ•° ====================
def parse_json_safely(text: str) -> Dict:
    try:
        return json.loads(text.strip())
    except:
        try:
            match = re.search(r'\{.*\}', text, re.DOTALL)
            if match:
                return json.loads(match.group())
        except Exception as e:
            st.error(f"è§£æ JSON å‡ºé”™: {e}")
    return {}

def clean_text(data: Union[str, List, Dict]) -> Union[str, List, Dict]:
    """é€’å½’æ¸…ç†æ–‡æœ¬ï¼Œä¿ç•™åˆ—è¡¨ç»“æ„ï¼Œé˜²æ­¢å°†åˆ—è¡¨è½¬ä¸ºå­—ç¬¦ä¸²"""
    # 1. å¦‚æœæ˜¯åˆ—è¡¨ï¼Œé€’å½’å¤„ç†æ¯ä¸€é¡¹
    if isinstance(data, list):
        return [clean_text(item) for item in data]
    
    # 2. å¦‚æœæ˜¯å­—å…¸ï¼Œé€’å½’å¤„ç†æ¯ä¸€ä¸ªå€¼
    if isinstance(data, dict):
        return {k: clean_text(v) for k, v in data.items()}
    
    # 3. å¦‚æœä¸æ˜¯å­—ç¬¦ä¸²ï¼ˆä¸”ä¸æ˜¯åˆ—è¡¨/å­—å…¸ï¼‰ï¼Œç›´æ¥è¿”å›ï¼ˆæ¯”å¦‚æ•°å­—ï¼‰
    if not isinstance(data, str):
        return data
    
    # 4. å­—ç¬¦ä¸²æ¸…ç†é€»è¾‘
    text = data.replace('\\n', '\n').replace('\\"', '"')
    text = re.sub(r'([^\n])###', r'\1\n\n###', text)
    return text.strip()

def format_list_to_markdown(content) -> str:
    """å°†åˆ—è¡¨å†…å®¹è½¬æ¢ä¸º Markdown æ— åºåˆ—è¡¨å­—ç¬¦ä¸²"""
    if isinstance(content, list):
        return "\n".join([f"- {item}" for item in content])
    return str(content)

# ==================== æ‰§è¡Œåˆ†æ ====================
def perform_analysis(model, product_input: str, web_context: str = "") -> Dict:
    batches = [
        ["overview", "ux_features", "growth_ops"],
        ["tech_stack", "data_metrics", "strategy_advice"]
    ]
    
    final_result = {}
    
    with st.status("ğŸ” æ­£åœ¨æ„å»ºäº§å“æ¨¡å‹...", expanded=True) as status:
        for i, batch_keys in enumerate(batches):
            status.write(f"æ­£åœ¨åˆ†ææ‰¹æ¬¡ {i+1}/2...")
            prompt = create_partial_prompt(product_input, batch_keys, web_context)
            
            try:
                response = model.generate_content(prompt)
                batch_json = parse_json_safely(response.text)
                
                for k in batch_keys:
                    if k not in batch_json or not batch_json[k]:
                        batch_json[k] = "âš ï¸ è¯¥ç»´åº¦æœªèƒ½æˆåŠŸç”Ÿæˆï¼Œè¯·å°è¯•é‡æ–°è¿è¡Œã€‚"
                
                final_result.update(batch_json)
            except Exception as e:
                for k in batch_keys:
                    final_result[k] = f"âŒ ç”Ÿæˆé”™è¯¯: {str(e)}"
        
        status.update(label="âœ… åˆ†æå®Œæˆ", state="complete", expanded=False)
    
    # ä½¿ç”¨é€’å½’æ¸…ç†å‡½æ•°ï¼Œç¡®ä¿åˆ—è¡¨ç»“æ„ä¸è¢«ç ´å
    cleaned_result = clean_text(final_result)
    return cleaned_result

# ==================== Markdown å¯¼å‡º ====================
def generate_markdown_report(product_name: str, analysis_result: Dict) -> str:
    """ç”Ÿæˆ Markdown æ ¼å¼çš„æŠ¥å‘Š"""
    
    # è¾…åŠ©å‡½æ•°ï¼šä»ç»“æœä¸­æå–å¹¶æ ¼å¼åŒ–
    def get_fmt(key):
        content = analysis_result.get(key, "æš‚æ— æ•°æ®")
        return format_list_to_markdown(content)

    return f"""# ç«å“åˆ†ææŠ¥å‘Šï¼š{product_name}
**ç”Ÿæˆæ—¶é—´ï¼š** {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}

---
## 1. ğŸ“Š ç«å“æ¦‚å†µ
{get_fmt("overview")}

## 2. ğŸ¯ åŠŸèƒ½ä¸ä½“éªŒåˆ†æ
{get_fmt("ux_features")}

## 3. ğŸ“ˆ è¿è¥ä¸å¢é•¿ç­–ç•¥
{get_fmt("growth_ops")}

## 4. ğŸ—ï¸ æŠ€æœ¯æ ˆåˆ†æ
{get_fmt("tech_stack")}

## 5. ğŸ’° æ•°æ®ä¸å•†ä¸šåŒ–
{get_fmt("data_metrics")}

## ğŸ’¡ ç­–ç•¥å¯å‘ä¸é”™ä½ç«äº‰
{get_fmt("strategy_advice")}

---
*æœ¬æŠ¥å‘Šç”± PM Insight Copilot è‡ªåŠ¨ç”Ÿæˆ*
"""

# ==================== å†å²è®°å½•ç®¡ç† ====================
def add_to_history(product_name: str, analysis_result: Dict):
    if 'history' not in st.session_state:
        st.session_state['history'] = []
    
    # ç§»é™¤æ—§è®°å½•
    st.session_state['history'] = [h for h in st.session_state['history'] if h['product'] != product_name]
    
    st.session_state['history'].insert(0, {
        'product': product_name,
        'timestamp': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        'analysis_result': analysis_result
    })
    
    if len(st.session_state['history']) > 20:
        st.session_state['history'] = st.session_state['history'][:20]

def get_history() -> List[Dict]:
    return st.session_state.get('history', [])

# ==================== UI æ¸²æŸ“å‡½æ•° ====================
def display_content(title, content):
    """æ¸²æŸ“é•¿é¡µé¢ä¸­çš„æ¯ä¸€ä¸ªåˆ†æç« èŠ‚"""
    st.markdown(f"## {title}")
    st.markdown('<div class="analysis-section" style="background-color: #ffffff; border: 1px solid #e6e9ef; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">', unsafe_allow_html=True)
    
    # å¦‚æœæ˜¯åˆ—è¡¨ï¼Œè½¬æ¢ä¸º Markdown åˆ—è¡¨å±•ç¤º
    if isinstance(content, list):
        formatted_list = "\n".join([f"- {item}" for item in content])
        st.markdown(formatted_list)
    elif isinstance(content, dict):
        st.write(content)
    else:
        st.markdown(str(content))
        
    st.markdown('</div>', unsafe_allow_html=True)

# ==================== ä¸»ç•Œé¢ ====================
def main():
    # ä¾§è¾¹æ 
    with st.sidebar:
        st.header("ğŸ“š å†å²è®°å½•")
        history = get_history()
        
        if history:
            st.write(f"æœ€è¿‘æŸ¥è¯¢äº† {len(history)} ä¸ªäº§å“")
            st.markdown("---")
            for idx, record in enumerate(history):
                if st.button(f"{idx + 1}. {record['product']}", key=f"history_{idx}", use_container_width=True):
                    st.session_state['selected_product'] = record['product']
                    st.session_state['last_analysis'] = record['analysis_result']
                    st.session_state['last_product'] = record['product']
                    st.session_state['last_markdown'] = generate_markdown_report(record['product'], record['analysis_result'])
                    st.rerun()
            
            if st.button("ğŸ—‘ï¸ æ¸…ç©ºå†å²è®°å½•", use_container_width=True):
                st.session_state['history'] = []
                st.rerun()
        else:
            st.info("æš‚æ— å†å²è®°å½•")

    # æ ‡é¢˜
    st.markdown('<h1 class="main-header">ğŸ“Š PM Insight Copilot</h1>', unsafe_allow_html=True)
    st.markdown('<p class="sub-header">AI é©±åŠ¨çš„ç«å“æ·±åº¦åˆ†æå·¥å…·</p>', unsafe_allow_html=True)
    
    model = init_gemini()
    
    st.markdown("---")
    col_input1, col_input2 = st.columns([4, 1])
    
    with col_input1:
        default_value = st.session_state.get('selected_product', '')
        if not default_value:
            default_value = st.session_state.get('last_product', '')
        
        if st.session_state.get('selected_product'):
            del st.session_state['selected_product']
        
        product_input = st.text_input(
            "è¯·è¾“å…¥ç«å“åç§°æˆ–äº§å“æè¿°",
            value=default_value,
            placeholder="ä¾‹å¦‚ï¼šChatGPTã€Perplexityã€Granola ç­‰",
            label_visibility="visible"
        )
    
    with col_input2:
        st.markdown("<br>", unsafe_allow_html=True)
        analyze_button = st.button("ğŸš€ å¼€å§‹æ·±åº¦åˆ†æ", type="primary", use_container_width=True)
    
    st.markdown("---")

    # æ‰§è¡Œåˆ†æ
    if analyze_button:
        if not product_input.strip():
            st.warning("âš ï¸ è¯·è¾“å…¥ç«å“åç§°æˆ–äº§å“æè¿°")
        else:
            with st.status("ğŸ›¸ æ­£åœ¨å…¨ç½‘æœé›†æƒ…æŠ¥...", expanded=True) as status:
                st.write("æ­£åœ¨æ£€ç´¢æœ€æ–°å¸‚åœºåŠ¨æ€ (Tavily)...")
                web_info = fetch_competitor_context(product_input)
                
                st.write("æƒ…æŠ¥å·²æ±‡æ€»ï¼Œæ­£åœ¨è¿›è¡Œé€»è¾‘å»ºæ¨¡...")
                analysis_result = perform_analysis(model, product_input, web_info)
            
            if analysis_result:
                status.update(label="âœ… æ·±åº¦åˆ†æå®Œæˆ", state="complete", expanded=False)                
                add_to_history(product_input, analysis_result)
                st.session_state['last_analysis'] = analysis_result
                st.session_state['last_product'] = product_input
                st.session_state['last_markdown'] = generate_markdown_report(product_input, analysis_result)
                st.rerun()

    # æ˜¾ç¤ºç»“æœï¼ˆç«–å‘é•¿é¡µé¢ï¼‰
    if 'last_analysis' in st.session_state and st.session_state.get('last_analysis'):
        res = st.session_state['last_analysis']
        product_name = st.session_state.get('last_product', 'æœªçŸ¥äº§å“')
        
        st.success(f"âœ… {product_name} æ·±åº¦è°ƒç ”æŠ¥å‘Šå·²ç”Ÿæˆ")
        st.info("ğŸ’¡ æŠ¥å‘Šå·²æŒ‰ç»´åº¦å‚ç›´å±•å¼€ï¼Œå¯ç›´æ¥æ»šåŠ¨é˜…è¯»æˆ–ä¸‹è½½å®Œæ•´æŠ¥å‘Šã€‚")
        
        sections = [
            ("ğŸ” ç«å“æ¦‚å†µ", "overview"),
            ("ğŸ¯ åŠŸèƒ½åœºæ™¯åˆ†æ", "ux_features"),
            ("ğŸ“ˆ å¢é•¿ä¸è¿è¥ç­–ç•¥", "growth_ops"),
            ("ğŸ—ï¸ æŠ€æœ¯æ ˆä¸åº•å±‚æ¶æ„", "tech_stack"),
            ("ğŸ’° å•†ä¸šåŒ–ä¸ä»·å€¼è¯„ä¼°", "data_metrics"),
            ("ğŸ’¡ é”™ä½ç«äº‰å»ºè®®", "strategy_advice")
        ]
        
        for title, key in sections:
            content = res.get(key, "æš‚æ— å†…å®¹")
            
            # ç‰¹æ®Šé«˜äº®æœ€åä¸€é¡¹
            if key == "strategy_advice":
                st.markdown(f"## {title}")
                st.markdown('<div class="analysis-section" style="background-color: #e3f2fd; border-left: 8px solid #1f77b4; padding: 20px; border-radius: 10px;">', unsafe_allow_html=True)
                # ä¹Ÿè¦å¤„ç†åˆ—è¡¨æ ¼å¼
                if isinstance(content, list):
                    st.markdown("\n".join([f"- {item}" for item in content]))
                else:
                    st.markdown(str(content))
                st.markdown('</div>', unsafe_allow_html=True)
            else:
                display_content(title, content)
            
            st.markdown("---")

        st.download_button(
            label="ğŸ“¥ ä¸‹è½½å®Œæ•´åˆ†ææŠ¥å‘Š (Markdown)",
            data=st.session_state.get('last_markdown', ''),
            file_name=f"è°ƒç ”æŠ¥å‘Š_{product_name}.md",
            mime="text/markdown",
            type="primary",
            use_container_width=True
        )

if __name__ == "__main__":
    main()